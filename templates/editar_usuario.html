{% extends "base.html" %}

{% block title %}Editar Usu√°rio{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-person-lines-fill"></i> Editar Usu√°rio</h2>
                <a href="{{ url_for('gerenciar_usuarios') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>

            <div class="card">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('editar_usuario', id=usuario.id) }}">
                        <div class="mb-3">
                            <label class="form-label">Nome de Usu√°rio</label>
                            <input type="text" name="username" class="form-control" value="{{ usuario.username }}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" value="{{ usuario.email }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">Fun√ß√£o/Cargo</label>
                            <select class="form-select" id="role" name="role">
                                <option value="user" {% if usuario.role == 'user' %}selected{% endif %}>Usu√°rio</option>
                                <option value="administrativo" {% if usuario.role == 'administrativo' %}selected{% endif %}>Administrativo</option>
                                <option value="tech" {% if usuario.role == 'tech' %}selected{% endif %}>T√©cnico</option>
                                <option value="supervisor" {% if usuario.role == 'supervisor' %}selected{% endif %}>Supervisor</option>
                                <option value="diretor" {% if usuario.role == 'diretor' %}selected{% endif %}>Diretor</option>
                                <option value="admin" {% if usuario.role == 'admin' %}selected{% endif %}>Administrador</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="funcao_id" class="form-label">Fun√ß√£o/Cargo</label>
                            <select class="form-select" id="funcao_id" name="funcao_id">
                                <option value="">Selecione uma fun√ß√£o/cargo</option>
                                {% for funcao in funcoes %}
                                <option value="{{ funcao.id }}" {% if usuario.funcao_id == funcao.id %}selected{% endif %}>
                                    {{ funcao.nome }} (N√≠vel {{ funcao.nivel_acesso }})
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                A fun√ß√£o determina o n√≠vel de acesso do usu√°rio no sistema.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nova Senha (deixe em branco para manter a atual)</label>
                            <input type="password" name="password" class="form-control">
                        </div>

                        <!-- Se√ß√£o de Permiss√µes Granulares -->
                        {% set user_permissions = user_permissions|default([]) %}
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-shield-lock"></i> Permiss√µes de Acesso
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <i class="bi bi-info-circle"></i> Configure individualmente quais funcionalidades este usu√°rio pode acessar
                                </p>
                                
                                <div class="row g-3" id="permissions-container">
                                    <!-- Permiss√£o: Visualizar Chamados -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-ticket-perforated me-2"></i>
                                                    <strong>Visualizar Chamados</strong>
                                                    <br>
                                                    <small class="text-muted">Ver todos os chamados do sistema</small>
                                                </div>
                                                {% set is_enabled = 'view_chamados' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="view_chamados"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}
                                                    <i class="bi bi-check-circle-fill"></i> Permitido
                                                    {% else %}
                                                    <i class="bi bi-x-circle-fill"></i> Negado
                                                    {% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_view_chamados" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Criar Chamados -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-plus-circle me-2"></i>
                                                    <strong>Criar Chamados</strong>
                                                    <br>
                                                    <small class="text-muted">Abrir novos chamados</small>
                                                </div>
                                                {% set is_enabled = 'create_chamados' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="create_chamados"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_create_chamados" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Editar Chamados -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-pencil-square me-2"></i>
                                                    <strong>Editar Chamados</strong>
                                                    <br>
                                                    <small class="text-muted">Modificar chamados existentes</small>
                                                </div>
                                                {% set is_enabled = 'edit_chamados' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="edit_chamados"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_edit_chamados" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Deletar Chamados -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-trash me-2"></i>
                                                    <strong>Deletar Chamados</strong>
                                                    <br>
                                                    <small class="text-muted">Excluir chamados do sistema</small>
                                                </div>
                                                {% set is_enabled = 'delete_chamados' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="delete_chamados"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_delete_chamados" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Atribuir Chamados -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-person-check me-2"></i>
                                                    <strong>Atribuir Chamados</strong>
                                                    <br>
                                                    <small class="text-muted">Designar chamados para t√©cnicos</small>
                                                </div>
                                                {% set is_enabled = 'assign_chamados' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="assign_chamados"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_assign_chamados" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Gerenciar Equipamentos -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-laptop me-2"></i>
                                                    <strong>Gerenciar Equipamentos</strong>
                                                    <br>
                                                    <small class="text-muted">Acessar infraestrutura</small>
                                                </div>
                                                {% set is_enabled = 'manage_infrastructure' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="manage_infrastructure"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_manage_infrastructure" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Gerenciar Usu√°rios -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-people me-2"></i>
                                                    <strong>Gerenciar Usu√°rios</strong>
                                                    <br>
                                                    <small class="text-muted">Criar/editar usu√°rios</small>
                                                </div>
                                                {% set is_enabled = 'manage_users' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="manage_users"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_manage_users" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>

                                    <!-- Permiss√£o: Acessar Chat -->
                                    <div class="col-md-6">
                                        <div class="permission-item p-3 border rounded">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <i class="bi bi-chat-dots me-2"></i>
                                                    <strong>Acessar Chat</strong>
                                                    <br>
                                                    <small class="text-muted">Chat de suporte</small>
                                                </div>
                                                {% set is_enabled = 'access_chat' in user_permissions %}
                                                <button type="button" class="btn btn-toggle permission-toggle" 
                                                        data-permission="access_chat"
                                                        data-enabled="{{ 'true' if is_enabled else 'false' }}">
                                                    {% if is_enabled %}<i class="bi bi-check-circle-fill"></i> Permitido{% else %}<i class="bi bi-x-circle-fill"></i> Negado{% endif %}
                                                </button>
                                            </div>
                                            <input type="hidden" name="permission_access_chat" value="{{ '1' if is_enabled else '0' }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Salvar Altera√ß√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.permission-item {
    transition: all 0.3s ease;
}

.permission-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-toggle {
    min-width: 120px;
    font-weight: 600;
    border: 2px solid;
    transition: all 0.3s ease;
    cursor: pointer;
    pointer-events: auto;
    z-index: 10;
    position: relative;
}

.btn-toggle[data-enabled="true"] {
    background-color: #28a745;
    color: white;
    border-color: #28a745;
}

.btn-toggle[data-enabled="true"]:hover {
    background-color: #218838;
    border-color: #1e7e34;
    transform: scale(1.05);
}

.btn-toggle[data-enabled="false"] {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
}

.btn-toggle[data-enabled="false"]:hover {
    background-color: #c82333;
    border-color: #bd2130;
    transform: scale(1.05);
}

.permission-item[data-status="enabled"] {
    border-color: #28a745 !important;
    background-color: #f8fff9;
}

.permission-item[data-status="disabled"] {
    border-color: #dc3545 !important;
    background-color: #fff8f8;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
console.log('üîß Carregando sistema de permiss√µes...');

document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM carregado');
    
    const toggleButtons = document.querySelectorAll('.permission-toggle');
    console.log('üîò Bot√µes encontrados:', toggleButtons.length);
    
    if (toggleButtons.length === 0) {
        console.error('‚ùå Nenhum bot√£o .permission-toggle encontrado!');
        return;
    }
    
    toggleButtons.forEach(function(button, index) {
        console.log(`Configurando bot√£o ${index + 1}:`, button.getAttribute('data-permission'));
        
        // Definir status inicial do card
        updatePermissionItemStatus(button);
        
        // Garantir que o bot√£o est√° clic√°vel
        button.style.cursor = 'pointer';
        button.style.pointerEvents = 'auto';
        
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üñ±Ô∏è Bot√£o clicado:', this.getAttribute('data-permission'));
            
            const permission = this.getAttribute('data-permission');
            const currentStatus = this.getAttribute('data-enabled') === 'true';
            const newStatus = !currentStatus;
            
            console.log(`Mudando de ${currentStatus} para ${newStatus}`);
            
            // Atualizar o bot√£o
            this.setAttribute('data-enabled', newStatus.toString());
            
            // Atualizar o input hidden
            const hiddenInput = this.closest('.permission-item').querySelector('input[name="permission_' + permission + '"]');
            if (hiddenInput) {
                hiddenInput.value = newStatus ? '1' : '0';
                console.log('Input hidden atualizado:', hiddenInput.value);
            }
            
            // Atualizar visual do bot√£o
            if (newStatus) {
                this.innerHTML = '<i class="bi bi-check-circle-fill"></i> Permitido';
                this.classList.remove('btn-danger');
                this.classList.add('btn-success');
            } else {
                this.innerHTML = '<i class="bi bi-x-circle-fill"></i> Negado';
                this.classList.remove('btn-success');
                this.classList.add('btn-danger');
            }
            
            // Atualizar status do card
            updatePermissionItemStatus(this);
            
            // Feedback visual
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 150);
            
            console.log('‚úÖ Atualiza√ß√£o conclu√≠da');
        }, false);
        
        // Adicionar feedback visual no hover
        button.addEventListener('mouseenter', function() {
            this.style.opacity = '0.9';
        });
        
        button.addEventListener('mouseleave', function() {
            this.style.opacity = '1';
        });
    });
    
    function updatePermissionItemStatus(button) {
        const permissionItem = button.closest('.permission-item');
        const isEnabled = button.getAttribute('data-enabled') === 'true';
        
        if (permissionItem) {
            if (isEnabled) {
                permissionItem.setAttribute('data-status', 'enabled');
            } else {
                permissionItem.setAttribute('data-status', 'disabled');
            }
        }
    }
    
    console.log('‚úÖ Sistema de permiss√µes configurado com sucesso!');
});
</script>
{% endblock %}
