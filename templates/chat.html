{% extends 'base.html' %}

{% block title %}Chat de Suporte{% endblock %}

{% block content %}
<style>
    /* Estilo WhatsApp */
    .chat-container {
        height: calc(100vh - 150px);
        display: flex;
        flex-direction: column;
        background: #e5ddd5;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .chat-header {
        background: #075e54;
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .chat-header i {
        font-size: 1.5rem;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23e5ddd5" width="100" height="100"/></svg>');
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
        animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .message.me {
        justify-content: flex-end;
    }
    
    .message.other {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 65%;
        padding: 8px 12px;
        border-radius: 8px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.me .message-bubble {
        background: #dcf8c6;
        border-radius: 8px 8px 0 8px;
    }
    
    .message.other .message-bubble {
        background: white;
        border-radius: 8px 8px 8px 0;
    }
    
    .message-username {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .user-avatar {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
        color: white;
        flex-shrink: 0;
    }
    
    .message-text {
        margin: 5px 0;
        line-height: 1.4;
    }
    
    .message-time {
        font-size: 0.7rem;
        color: #667781;
        text-align: right;
        margin-top: 3px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 3px;
    }
    
    .message.me .message-bubble {
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }
    
    .message.other .message-bubble {
        box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
    }
    
    .chat-input-area {
        background: #f0f0f0;
        padding: 15px;
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .chat-input {
        flex: 1;
        border: none;
        border-radius: 25px;
        padding: 12px 20px;
        font-size: 0.95rem;
        outline: none;
    }
    
    .chat-send-btn {
        background: #075e54;
        color: white;
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .chat-send-btn:hover {
        background: #128c7e;
        transform: scale(1.05);
    }
    
    .chat-send-btn:active {
        transform: scale(0.95);
    }
    
    .typing-indicator {
        display: none;
        padding: 10px 15px;
        background: white;
        border-radius: 8px;
        width: fit-content;
        margin-bottom: 10px;
    }
    
    .typing-indicator span {
        height: 8px;
        width: 8px;
        background: #667781;
        border-radius: 50%;
        display: inline-block;
        margin: 0 2px;
        animation: typing 1.4s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-10px); }
    }
    
    .no-messages {
        text-align: center;
        color: #667781;
        padding: 40px 20px;
    }
    
    .no-messages i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    /* Mobile responsivo */
    @media (max-width: 768px) {
        .chat-container {
            height: calc(100vh - 100px);
        }
        
        .message-bubble {
            max-width: 80%;
        }
    }
</style>

<div class="container-fluid p-0" style="height: calc(100vh - 56px);">
    <div class="row h-100 g-0">
        <div class="col-12">
            <div class="chat-container">
                <!-- Cabe√ßalho do Chat -->
                <div class="chat-header">
                    <i class="bi bi-chat-dots-fill"></i>
                    <div>
                        <h5 class="mb-0">Chat de Suporte TI</h5>
                        <small class="opacity-75">
                            <span id="online-users">Carregando...</span>
                        </small>
                    </div>
                    <div class="ms-auto d-flex gap-2">
                        <button class="btn btn-sm" onclick="novaConversa()" title="Nova Conversa" 
                                style="background: rgba(255,255,255,0.2); color: white; border: none;">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                        <button class="btn btn-sm" onclick="limparChat()" title="Limpar minha tela"
                                style="background: rgba(255,255,255,0.2); color: white; border: none;">
                            <i class="bi bi-brush"></i>
                        </button>
                        <button class="btn btn-sm" onclick="apagarTodasMensagens()" title="Apagar todas as mensagens"
                                style="background: rgba(255,255,255,0.2); color: white; border: none;">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>
                
                <!-- √Årea de Mensagens -->
                <div class="chat-messages" id="chatMessages">
                    <div class="no-messages" id="noMessages">
                        <i class="bi bi-chat-text"></i>
                        <p>Nenhuma mensagem ainda.<br>Seja o primeiro a iniciar a conversa!</p>
                    </div>
                </div>
                
                <!-- Indicador de digita√ß√£o -->
                <div class="typing-indicator" id="typingIndicator">
                    <span></span><span></span><span></span>
                </div>
                
                <!-- √Årea de Input -->
                <div class="chat-input-area">
                    <button class="btn" style="color: #54656f; background: transparent; border: none; font-size: 1.5rem;" title="Emoji">
                        <i class="bi bi-emoji-smile"></i>
                    </button>
                    <input type="text" 
                           class="chat-input" 
                           id="messageInput" 
                           placeholder="Digite uma mensagem"
                           autocomplete="off">
                    <button class="chat-send-btn" onclick="enviarMensagem()" title="Enviar mensagem">
                        <i class="bi bi-send-fill"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Verificar se jQuery est√° dispon√≠vel
if (typeof $ === 'undefined') {
    console.log('‚ö†Ô∏è jQuery n√£o encontrado, carregando...');
    const script = document.createElement('script');
    script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
    script.onload = function() {
        console.log('‚úÖ jQuery carregado');
        // Aguardar um pouco para garantir que o jQuery est√° totalmente carregado
        setTimeout(initializeChat, 100);
    };
    document.head.appendChild(script);
} else {
    console.log('‚úÖ jQuery j√° dispon√≠vel');
    initializeChat();
}

// Vari√°veis globais
let ultimoIdMensagem = 0;
let chatInterval;

// Fun√ß√µes globais para os bot√µes HTML
function enviarMensagem() {
    const mensagem = document.getElementById('messageInput').value.trim();
    
    console.log('üì§ Tentando enviar mensagem:', mensagem);
    
    if (!mensagem) {
        console.log('‚ùå Mensagem vazia, n√£o enviando');
        return;
    }
    
    // Limpar input
    document.getElementById('messageInput').value = '';
    
    console.log('üîÑ Enviando para servidor...');
    
    // Enviar para servidor
    fetch('/api/chat/enviar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ mensagem: mensagem })
    })
    .then(response => {
        console.log('üì° Resposta do servidor:', response.status);
        if (response.status === 401) {
            alert('Sess√£o expirada. Fa√ßa login novamente.');
            window.location.href = '/login';
            return;
        }
        return response.json();
    })
    .then(data => {
        console.log('üì® Dados recebidos:', data);
        if (data && data.success) {
            console.log('‚úÖ Mensagem enviada com sucesso:', data.mensagem);
            adicionarMensagemNaTela(data.mensagem);
            ultimoIdMensagem = data.mensagem.id;
            scrollToBottom();
            
            // Ocultar mensagem "Nenhuma mensagem ainda" se existir
            const noMessages = document.getElementById('noMessages');
            if (noMessages) {
                noMessages.style.display = 'none';
            }
        } else if (data && data.error) {
            console.error('‚ùå Erro do servidor:', data.error);
            alert('Erro: ' + data.error);
        } else {
            console.error('‚ùå Resposta inv√°lida do servidor:', data);
            alert('Resposta inv√°lida do servidor');
        }
    })
    .catch(error => {
        console.error('‚ùå Erro ao enviar mensagem:', error);
        alert('Erro ao enviar mensagem. Tente novamente.');
    });
}

function limparChat() {
    if (confirm('Limpar hist√≥rico do chat na sua tela? (N√£o afeta outros usu√°rios)')) {
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = `
            <div class="no-messages" id="noMessages">
                <i class="bi bi-chat-text"></i>
                <p>Nenhuma mensagem ainda</p>
                <small class="text-muted">Seja o primeiro a enviar uma mensagem!</small>
            </div>
        `;
        ultimoIdMensagem = 0;
        console.log('üßπ Chat limpo na sua tela');
    }
}

function novaConversa() {
    if (confirm('Iniciar uma nova conversa? Isso limpar√° o chat para todos os usu√°rios.')) {
        console.log('üÜï Iniciando nova conversa...');
        
        fetch('/api/chat/nova-conversa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('üì° Resposta do servidor:', response.status);
            if (response.status === 401) {
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = '/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('üì® Dados recebidos:', data);
            if (data && data.success) {
                console.log('‚úÖ Nova conversa iniciada');
                // Limpar a tela local e mostrar mensagem de confirma√ß√£o
                ultimoIdMensagem = 0;
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="message other">
                        <div class="message-bubble">
                            <div class="message-text text-center text-success">
                                <i class="bi bi-check-circle-fill"></i> Nova conversa iniciada!
                            </div>
                        </div>
                    </div>
                `;
                
                alert('Nova conversa iniciada! Todas as mensagens anteriores foram removidas.');
            } else if (data && data.error) {
                console.error('‚ùå Erro do servidor:', data.error);
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao iniciar nova conversa:', error);
            alert('Erro ao iniciar nova conversa. Tente novamente.');
        });
    }
}

function apagarTodasMensagens() {
    if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso apagar√° TODAS as mensagens do chat para TODOS os usu√°rios!\n\nTem certeza que deseja continuar?')) {
        console.log('üóëÔ∏è Apagando todas as mensagens...');
        
        fetch('/api/chat/apagar-todas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log('üì° Resposta do servidor:', response.status);
            if (response.status === 401) {
                alert('Sess√£o expirada. Fa√ßa login novamente.');
                window.location.href = '/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('üì® Dados recebidos:', data);
            if (data && data.success) {
                console.log('‚úÖ Todas as mensagens apagadas');
                // Limpar a tela local
                ultimoIdMensagem = 0;
                
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="no-messages" id="noMessages">
                        <i class="bi bi-chat-text"></i>
                        <p>Nenhuma mensagem ainda</p>
                        <small class="text-muted">Seja o primeiro a enviar uma mensagem!</small>
                    </div>
                `;
                
                alert('Todas as mensagens foram apagadas com sucesso!');
            } else if (data && data.error) {
                console.error('‚ùå Erro do servidor:', data.error);
                alert('Erro: ' + data.error);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao apagar mensagens:', error);
            alert('Erro ao apagar mensagens. Tente novamente.');
        });
    }
}

function carregarMensagens() {
    console.log('üîÑ Carregando mensagens...');
    
    fetch('/api/chat/mensagens')
        .then(response => {
            console.log('üì° Status da resposta:', response.status);
            if (response.status === 401) {
                console.log('‚ùå N√£o autenticado - redirecionando para login');
                window.location.href = '/login';
                return;
            }
            return response.json();
        })
        .then(data => {
            console.log('üì® Dados recebidos:', data);
            
            if (data && data.mensagens && data.mensagens.length > 0) {
                console.log(`üìù ${data.mensagens.length} mensagens encontradas`);
                
                // Ocultar mensagem "Nenhuma mensagem ainda" se existir
                const noMessages = document.getElementById('noMessages');
                if (noMessages) {
                    noMessages.style.display = 'none';
                }
                
                // Verificar se h√° novas mensagens
                const novasMensagens = data.mensagens.filter(m => m.id > ultimoIdMensagem);
                console.log(`üÜï ${novasMensagens.length} novas mensagens`);
                
                if (novasMensagens.length > 0) {
                    novasMensagens.forEach(msg => {
                        console.log('‚ûï Adicionando mensagem:', msg);
                        adicionarMensagemNaTela(msg);
                    });
                    
                    ultimoIdMensagem = Math.max(...data.mensagens.map(m => m.id));
                    scrollToBottom();
                }
            } else {
                console.log('üì≠ Nenhuma mensagem encontrada');
                
                // Mostrar mensagem "Nenhuma mensagem ainda" se existir
                const noMessages = document.getElementById('noMessages');
                if (noMessages) {
                    noMessages.style.display = 'block';
                }
            }
            
            // Atualizar contador de usu√°rios online (simulado)
            if (data && data.mensagens) {
                const onlineUsers = document.getElementById('online-users');
                if (onlineUsers) {
                    onlineUsers.textContent = data.mensagens.length > 0 ? 'Chat ativo' : 'Aguardando mensagens';
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar mensagens:', error);
        });
}

function adicionarMensagemNaTela(msg) {
    const messageClass = msg.is_me ? 'me' : 'other';
    const dataEnvio = new Date(msg.data_envio);
    const horaFormatada = dataEnvio.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
    
    // Gerar cor √∫nica para cada usu√°rio baseado no nome
    const getUserColor = (username) => {
        const colors = [
            '#00a884', '#0088cc', '#8e24aa', '#d32f2f', '#f57c00',
            '#388e3c', '#0277bd', '#c2185b', '#7b1fa2', '#0097a7'
        ];
        let hash = 0;
        for (let i = 0; i < username.length; i++) {
            hash = username.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    };
    
    // Pegar iniciais do nome
    const getInitials = (username) => {
        return username.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    };
    
    const userColor = getUserColor(msg.username);
    const userInitials = getInitials(msg.username);
    
    const messageHtml = `
        <div class="message ${messageClass}" data-id="${msg.id}">
            <div class="message-bubble">
                ${!msg.is_me ? `
                    <div class="message-username">
                        <span class="user-avatar" style="background-color: ${userColor}">
                            ${userInitials}
                        </span>
                        <span style="color: ${userColor}">${escapeHtml(msg.username)}</span>
                    </div>
                ` : ''}
                <div class="message-text">${escapeHtml(msg.mensagem)}</div>
                <div class="message-time">
                    ${horaFormatada}
                    ${msg.is_me ? '<i class="bi bi-check-all" style="color: #4fc3f7; margin-left: 3px;"></i>' : ''}
                </div>
            </div>
        </div>
    `;
    
    // Verificar se mensagem j√° existe
    if ($(`[data-id="${msg.id}"]`).length === 0) {
        $('#chatMessages').append(messageHtml);
    }
}


function marcarComoLidas() {
    fetch('/api/chat/marcar-lidas', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    });
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function initializeChat() {
    // Verificar se jQuery est√° dispon√≠vel antes de usar
    if (typeof $ === 'undefined') {
        console.error('‚ùå jQuery ainda n√£o est√° dispon√≠vel');
        return;
    }
    
    console.log('üöÄ Inicializando chat com jQuery');
    
    // Carregar mensagens ao abrir a p√°gina
    $(document).ready(function() {
        carregarMensagens();
        marcarComoLidas();
        
        // Atualizar mensagens a cada 3 segundos
        chatInterval = setInterval(carregarMensagens, 3000);
        
        // Enter para enviar
        $('#messageInput').keypress(function(e) {
            if(e.which == 13) {
                enviarMensagem();
                return false;
            }
        });
        
        // Marcar como lidas ao focar na janela
        $(window).focus(function() {
            marcarComoLidas();
        });
        
        // Parar atualiza√ß√£o ao sair da p√°gina
        $(window).on('beforeunload', function() {
            if (chatInterval) {
                clearInterval(chatInterval);
            }
        });
    });
}

// ‚úÖ Vers√£o 3.0 - Clone WhatsApp com identifica√ß√£o de usu√°rios
// - Avatar colorido por usu√°rio
// - Nome do usu√°rio em cada mensagem
// - Cores √∫nicas baseadas no hash do nome
// - Check duplo azul nas mensagens enviadas
// - Visual 100% WhatsApp
</script>
{% endblock %}

